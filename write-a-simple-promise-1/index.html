<!DOCTYPE html>
<html>

<!-- Mirrored from localhost:2368/write-a-simple-promise-1/ by HTTrack Website Copier/3.x [XR&CO'2014], Sun, 06 Dec 2015 02:48:16 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <title>Write A Simple Promise in 100 Lines Part1</title>

    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <meta name="description" content="">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Write A Simple Promise in 100 Lines Part1">
    <meta name="twitter:description" content="">

    <meta property="og:type" content="article">
    <meta property="og:title" content="Write A Simple Promise in 100 Lines Part1">
    <meta property="og:description" content="">

    <link rel="icon" type="image/png" href="../assets/images/favicon.png" />
    <link href="../assets/images/favicon.png" rel="shortcut icon" type="image/png">
    <link href="../apple-touch-icon-precomposed.png/index.html" rel="apple-touch-icon">

    <link rel="stylesheet" type="text/css" href="../assets/css/vno86b5.css?v=8e02a3de55" />
    <link href="http://netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="../assets/css/tomorrow86b5.css?v=8e02a3de55">
    
    <link rel="canonical" href="index.html" />
    <meta name="referrer" content="origin" />
    
    <meta property="og:site_name" content="Lanston Peng's ideas" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Write A Simple Promise in 100 Lines Part1" />
    <meta property="og:description" content="The Problems We May Encounter Manage asynchronize tasks invoke a callback while a few independent asynchronize function finish   deep async call We start from a story Tony, a boy who loves playing Pokemon,is only allowed to play after cleaning..." />
    <meta property="og:url" content="index.html" />
    <meta property="article:published_time" content="2013-12-13T23:38:49.000Z" />
    <meta property="article:modified_time" content="2013-12-13T23:38:49.000Z" />
    
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Write A Simple Promise in 100 Lines Part1" />
    <meta name="twitter:description" content="The Problems We May Encounter Manage asynchronize tasks invoke a callback while a few independent asynchronize function finish   deep async call We start from a story Tony, a boy who loves playing Pokemon,is only allowed to play after cleaning..." />
    <meta name="twitter:url" content="index.html" />
    
    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Article",
    "publisher": "Lanston Peng's ideas",
    "author": {
        "@type": "Person",
        "name": "lanstonpeng",
        "url": "http://localhost:2368/author/lanstonpeng",
        "sameAs": null,
        "description": null
    },
    "headline": "Write A Simple Promise in 100 Lines Part1",
    "url": "http://localhost:2368/write-a-simple-promise-1/",
    "datePublished": "2013-12-13T23:38:49.000Z",
    "dateModified": "2013-12-13T23:38:49.000Z",
    "description": "The Problems We May Encounter Manage asynchronize tasks invoke a callback while a few independent asynchronize function finish   deep async call We start from a story Tony, a boy who loves playing Pokemon,is only allowed to play after cleaning..."
}
    </script>

    <meta name="generator" content="Ghost 0.7" />
    <link rel="alternate" type="application/rss+xml" title="Lanston Peng&#x27;s ideas" href="../rss/index.html" />

</head>
<body class="post-template no-js">

    <span class="mobile btn-mobile-menu">
        <i class="fa fa-list btn-mobile-menu__icon"></i>
        <i class="fa fa-angle-up btn-mobile-close__icon hidden"></i>
    </span>

    <header class="panel-cover panel-cover--collapsed" style="background-image: url(../content/images/2015/12/John-William-Waterhouse-Hylas-and-the-Nymphs.jpg)">
  <div class="panel-main">

    <div class="panel-main__inner panel-inverted">
    <div class="panel-main__content">

        <h1 class="panel-cover__title panel-title"><a href="../index.html" title="前往 Lanston Peng&#x27;s ideas 的主页">Lanston Peng&#x27;s ideas</a></h1>
        <span class="panel-cover__subtitle panel-subtitle"></span>
        <hr class="panel-cover__divider" />
        <p class="panel-cover__description">能不断品尝那无限的美好作品
做一个有趣,简单且随和的人</p>
        <!--
        <hr class="panel-cover__divider panel-cover__divider--secondary" />
        -->

        <div class="navigation-wrapper">
          <div>
          <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">
              <li class="navigation__item"><a href="../index.html#blog" title="访问博客" class="blog-button">博客</a></li>
              <li class="navigation__item"><a href="http://douban.com/people/lanstonpeng" target="_blank" title="我的豆瓣">豆瓣</a></li>
              <!--
              <li class="navigation__item"><a href="" title="了解更多关于我">关于</a></li>
              -->
            </ul>
          </nav>
          </div>
          <div>
          <nav class="cover-navigation navigation--social">
  <ul class="navigation">


  <!-- 豆瓣 
  <li class="navigation__item">
    <a href="http://www.douban.com/people/lanstonpeng/" title="诚实的奸商" target="_blank">
      <i class='social fa fa-facebook'></i>
      <span class="label">豆瓣</span>
    </a>
  </li>
  -->

  <!-- Github -->
  <li class="navigation__item">
    <a href="https://github.com/lanstonpeng" title="Github" target="_blank">
      <i class='social fa fa-github'></i>
      <span class="label">Github</span>
    </a>
  </li>

  <!-- Twitter -->
  <li class="navigation__item">
    <a href="http://twitter.com/lanstonpeng" title="@lanstonpeng" target="_blank">
      <i class='social fa fa-twitter'></i>
      <span class="label">Twitter</span>
    </a>
  </li>
  
  <!-- RSS -->
  <li class="navigation__item">
    <a href="../rss/index.html" rel="author" title="RSS" target="_blank">
      <i class='social fa fa-rss'></i>
      <span class="label">RSS</span>
    </a>
  </li>

  <!-- Email -->
  <li class="navigation__item">
    <a href="mailto:lanstonpeng@gmail.com" title="邮件联系我">
      <i class='social fa fa-envelope'></i>
      <span class="label">Email</span>
    </a>
  </li>

  </ul>
</nav>
          </div>
        </div>

      </div>

    </div>

    <div class="panel-cover--overlay cover-purple"></div>
  </div>
</header>

    <div class="content-wrapper">
        <div class="content-wrapper__inner">
            

  <article class="post-container post-container--single">

    <header class="post-header">
      <div class="post-meta">
        <time datetime="14 Dec 2013" class="post-meta__date date">14 Dec 2013</time> &#8226; <span class="post-meta__tags tags"></span>
        <!--<span class="post-meta__author author"><img src="" alt="profile image for lanstonpeng" class="avatar post-meta__avatar" /> by lanstonpeng</span>-->
      </div>
      <h1 class="post-title">Write A Simple Promise in 100 Lines Part1</h1>
    </header>

    <section class="post">
      <h4 id="theproblemswemayencounter">The Problems We May Encounter</h4>

<ul>
<li>Manage asynchronize tasks
<ul><li>invoke a callback while a few independent asynchronize function finish  </li>
<li>deep async call</li></ul></li>
</ul>

<h4 id="westartfromastory">We start from a story</h4>

<p>Tony, a boy who loves playing Pokemon,is only allowed to play after cleaning the desk and washing all the dishes  </p>

<pre><code  data-language="javascript">
    function washDish(cb){
        setTimeout(cb,1000); //oh boy,how fast Tony wash
    }
    function cleanDesk(cb){
        setTimeout(cb,2000);
    }
    function playPokemon(){
        console.log("Go,Pikachu");
    }

</code>
</pre>

<p>We may generate some codes as following  </p>

<pre>
<code  data-language="javascript">
    cleanDesk(function(){
        washDish(function(){
            playPokemon();
        });
    });

</code>
</pre>

<p>that's ok, and imagine we can write something like this  </p>

<pre>
<code  data-language="javascript">
    when_all_done(cleanDesk,washDish).call_this(playPokemon);

</code>
</pre> 

<p>It's not a big deal,why we have to write something like that <br />
before giving the answer,let's see in what circumstance can we not use   </p>

<h4 id="ifwecansolvethefollowinglistwedonthavetodealwiththisproblem">if we can solve the following list,we don't have to deal with this problem</h4>

<ul>
<li>manually handle the callback pyramid well   </li>
<li>get others to get intuitive understanding of your code</li>
</ul>

<p>You bet,if the code base doesn't scale much and we're clear and smart enough( yeah,we're smart ),we can simply ignore the first piece,But the second point is not so easy to handle,we don't know who will read our code(even we think that the code we wrote is beautiful ) and whether they'll be understood</p>

<h4 id="whatthissimplearticlemightofferyou">What this simple article might offer you</h4>

<ul>
<li>Give you an intuitive and step by step way of the implementation of Promise in javascript</li>
</ul>

<h4 id="inanutshellpromiseisanabstractpatternhelpspeopletowritereadableasynccodeandmanagethem"><em>In a nutshell,  Promise is an abstract pattern helps people to write readable async code and manage them</em></h4>

<hr />

<h4 id="letthejourneybegin">Let the journey begin</h4>

<p>There're plenty of implementations and I choose an intuitive one to cope with  </p>

<p>Say that there's a mystery guy called <em>Guru</em> who promise us that he'll do whatever we want after Tony's finishing something(still remember Tony?)  </p>

<p>If Tony can return this <strong>promise</strong> from Guru,and while the thing Tony has to to is fulfilled ,the <em>Guru</em> will notify us and carry out what's inside that <strong>promise</strong>(how nice Guru) ,feel free to do something else <br />
,let's alter the code a bit</p>

<pre>
<code  data-language="javascript">
    function cleanDesk(cb){
        var guru = guruGenerator();
        setTimeout(cb,1000);
        return guru.promise;
    }

</code>
</pre>

<p>Since we the Guru has to know that Tony's finsihing cleaning desk ,and the moment he knows ,he'll let us know,So we may add a little bit code like this  </p>

<pre>
<code  data-language="javascript">
    function cleanDesk(){
        var guru = guruGenerator();
        setTimeout(function(){
            guru.fulfill("Tony's finishing cleaning the nifty desk");
        },1000);
        return guru.promise;
    }

</code>
</pre>

<p>Notice that the parameter <code>cb</code> in cleanDesk is gone,since we'll assign it in another way <br />
As we hold the delicate <em>promise</em> from the Guru, we can put things we want <em>Guru</em> to fullfill after the particular thing is done by calling  <code>when_done_call_this</code> <br />
So, we may write something like:  </p>

<pre>
<code  data-language="javascript">
    var guruPromise = cleanDesk();//return the promise from Guru
    guruPromise.when_done_call_this(washDish);

</code>
</pre>

<p>what we've done is flattening the callback hell a little bit  </p>

<h4 id="howcanweachievethat">How can we achieve that?</h4>

<p>the skeleton looks like this  </p>

<pre>
<code  data-language="javascript">
function guruGenerator(){
    var promise = {
        when_done_call_this:function(){}
    };
    return {
        fulfill:function(){},
        promise:promise
    }
}

</code>
</pre>

<p>Since we can tell whatever we want after the specified thing is done(e.g <code>washDish</code>) <br />
like <code>guruPromise.when_done_call_this(washDish)</code> <br />
The Guru has to memory the things(like the <code>washDish</code> here) he has to deal with after the specified thing is done,So , we can add an array inside the Guru's body  </p>

<pre>
<code  data-language="javascript">
function guruGenerator(){
    var memory = [];
    var promise = {
        when_done_call_this:function( things_need_to_do ){
            memory.push(things_need_to_do);
        }
    };
    ...
}

</code>
</pre>

<p>And while the guru fulfill that <code>promise</code>,he just fetch the "todo list" from his memory and execute  </p>

<pre>
<code  data-language="javascript">
    function guruGenerator(){
        var memory = [];
        var promise = {
            when_done_call_this:function( things_need_to_do ){
                memory.push(things_need_to_do);
            }
        };
        return {
            fulfil:function(val){
                memory.forEach(function(thing,idx){
                    thing.call(null,val);
                });
            },
            promise:promise
        }
    }

</code>
</pre>

<p>Now,we can make the following code work  </p>

<pre>
<code  data-language="javascript">
    guruPromise.when_done_call_this(playPokemon);
    //print "Go,Pikachu" after ~1000ms

</code>
</pre>

<p>The next part ,we'll make the following snippet possible:  </p>

<pre>
<code  data-language="javascript">
guruPromise.when_done_call_this(playPokemon).when_done_call_this(playPokemon);

</code>
</pre>
    </section>

  </article>

  <section class="post-comments">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
      var disqus_shortname = 'lanston'; // required: replace example with your forum shortname
      

      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>



            <footer class="footer">
    <span class="footer__copyright">&copy; 2015  All rights reserved.</span>
    <span class="footer__copyright"><a href="https://github.com/onevcat/vno">Vno</a> theme by <a href="http://im.onevcat.com/">@onevcat</a></span>
</footer>        </div>
    </div>

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','http://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-45773367-1', 'auto');
  ga('send', 'pageview');

</script>

    <!-- Compatibility for Ghost 0.7.0: http://dev.ghost.org/no-more-jquery/ -->
    <script type="text/javascript">  
      if (typeof jQuery == 'undefined') {
        document.write('<script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></'+'script>');
      }
    </script>
    
    <script type="text/javascript" src="../assets/js/main86b5.js?v=8e02a3de55"></script>

    <script type="text/javascript" src="../assets/js/highlight.pack86b5.js?v=8e02a3de55"></script>
    <script>hljs.initHighlightingOnLoad();</script>
</body>

<!-- Mirrored from localhost:2368/write-a-simple-promise-1/ by HTTrack Website Copier/3.x [XR&CO'2014], Sun, 06 Dec 2015 02:48:16 GMT -->
</html>
